#!/bin/bash -eu

mkdir -p ${OPENSHIFT_WILDFLY_DIR}/{pid,logs}

/sbin/iptables -t nat -I PREROUTING -p tcp -m tcp --dport 4949 -j REDIRECT --to-ports 9990
/sbin/iptables -t nat -I PREROUTING -p tcp -m tcp --dport 4848 -j REDIRECT --to-ports 9993
service iptables save

# Initialize the JBoss CLI history file
[ -f ${OPENSHIFT_WILDFLY_DIR}/versions/8.2/.jboss-cli-history ] || touch ${OPENSHIFT_WILDFLY_DIR}/versions/8.2/.jboss-cli-history
#cd /usr/java/latest/bin
#keypass=`tr -cd '[:alnum:]' < /dev/urandom | fold -w30 | head -n1`;
#./keytool -genkeypair -alias serverkey -keyalg RSA -keysize 2048 -validity 7360 -keystore server.keystore -keypass $keypass -storepass $keypass -dname "cn=Server Administrator,o=Acme,c=GB";
#mv /usr/java/latest/bin/server.keystore ${OPENSHIFT_WILDFLY_DIR}/versions/8/standalone/configuration/
#chown jelastic:jelastic ${OPENSHIFT_WILDFLY_DIR}/versions/8/standalone/configuration/server.keystore
#sed -i s/mypassword/$keypass/ ${OPENSHIFT_WILDFLY_DIR}/versions/8/standalone/configuration/standalone.xml

sed -i 's/opt\/repo:\/bin\/bash/opt\/repo\/home:\/bin\/bash/g' "/etc/passwd"

[ -d "/opt/repo/.ssh" ] && mv /opt/repo/.ssh /opt/repo/home/;

[ -f "/opt/repo/.profile" ] && mv /opt/repo/.profile /opt/repo/home/;
[ -f "/opt/repo/.bash_profile" ] && mv /opt/repo/.bash_profile /opt/repo/home/;
[ -f "/opt/repo/.bash_history" ] && mv /opt/repo/.bash_history /opt/repo/home/;
